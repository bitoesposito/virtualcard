<p-toast class="absolute" />

<main class="max-w-20rem m-auto mt-5">
	<form [formGroup]="form" (ngSubmit)="editProfile()" class="flex flex-column gap-2 pb-4">
		<p-button *ngIf="isAdmin" label="Go to dashboard" [routerLink]="'private/dashboard'" icon="pi pi-arrow-left" severity="secondary" outlined="true" class="mb-2"/>
		<p class="text-2xl font-semibold">Edit Profile</p>

		<div *ngIf="!userData?.slug" class="p-3 border-round surface-100 mb-3">
			<p class="text-lg font-medium mb-2">Welcome to vCarder!</p>
			<p class="text-sm text-color-secondary">To make your profile public, complete the setup by entering your details and a custom link for your profile.</p>
		</div>

		<div class="flex gap-1 flex-column mb-2">
			<label for="profilePicture">Profile Picture</label>
			<img *ngIf="userData.profilePhoto" [src]="userData.profilePhoto"
                [alt]="userData.name + ' ' + userData.surname + ' profile photo'" class="border-round-md max-w-20rem mb-2 cursor-pointer"
                style="height: min-content;" (click)="fu.choose()"/>
            <div *ngIf="!userData.profilePhoto"
                class="border-round-md flex align-items-center justify-content-center surface-200 w-full h-min max-w-20rem mb-2 py-3 cursor-pointer"
                (click)="fu.choose()">
                <i class="pi pi-user text-2xl text-white text-color-secondary mr-2"></i>
				<p class="text-color-secondary">Upload a profile picture</p>
            </div>
			<p-fileupload #fu mode="basic" chooseLabel="Choose" chooseIcon="pi pi-upload" name="demo[]" url="https://www.primefaces.org/cdn/api/upload.php" accept="image/*" maxFileSize="1000000" (onUpload)="onProfilePictureUpload($event)" styleClass="justify-content-start" [style]="{'display': 'none'}"/>
		</div>

		<div class="flex gap-1 flex-column">
			<label for="name">Name</label>
			<input formControlName="name" type="text" pInputText placeholder="Enter your name" />
		</div>

		<div class="flex gap-1 flex-column">
			<label for="surname">Surname</label>
			<input formControlName="surname" type="text" pInputText placeholder="Enter your surname" />
		</div>

		<div class="flex gap-1 flex-column">
			<label for="phone">Phone Number</label>
			<div class="flex gap-1">
				<div class="flex gap-1 flex-column">
					<p-select formControlName="areaCode" [options]="area_code" optionLabel="label" optionValue="value"
						[placeholder]="selectedAreaCode ? selectedAreaCode : '+39'" class="w-min h-full" fluid="true"
						[filter]="true" filterBy="label" [panelStyleClass]="'w-10rem'" (onChange)="onAreaCodeChange($event)">
						<ng-template let-option pTemplate="item">
							<div class="flex items-center gap-2">
								<img [src]="option.flag" style="width: 22px" />
								<div>{{ option.label }}</div>
							</div>
						</ng-template>
						<ng-template let-selected pTemplate="selectedItem">
							<div>{{ selected.value }}</div>
						</ng-template>
					</p-select>
				</div>
				<input fluid="true" formControlName="phone" type="tel" pInputText
					placeholder="Enter phone number" />
			</div>
		</div>

		<div class="flex gap-1 flex-column">
			<label for="website">Website</label>
			<input id="website" type="text" pInputText formControlName="website" [class.ng-invalid]="form.get('website')?.invalid && form.get('website')?.touched" placeholder="Enter your website">
			<small class="text-red-500" *ngIf="form.get('website')?.invalid && form.get('website')?.touched">
				Please enter a valid URL
			</small>
		</div>

		<div class="flex gap-1 flex-column">
			<label for="slug">Profile Link</label>
			<input id="slug" type="text" pInputText formControlName="slug" 
				[class.ng-invalid]="form.get('slug')?.invalid && form.get('slug')?.touched" 
				placeholder="Enter your profile link">
			<small class="text-red-500" *ngIf="form.get('slug')?.errors?.['required'] && form.get('slug')?.touched">
				Profile link is required
			</small>
			<small class="text-red-500" *ngIf="form.get('slug')?.errors?.['pattern'] && form.get('slug')?.touched">
				The profile link must contain only lowercase letters, numbers and hyphens (3-50 characters)
			</small>
			<small class="text-red-500" *ngIf="form.get('slug')?.errors?.['minlength'] && form.get('slug')?.touched">
				The profile link must be at least 3 characters long
			</small>
			<small class="text-red-500" *ngIf="form.get('slug')?.errors?.['maxlength'] && form.get('slug')?.touched">
				The profile link cannot exceed 50 characters
			</small>
			<small class="text-red-500" *ngIf="slugError">
				{{ slugError }}
			</small>
		</div>

		<p-divider />

		<div class="flex gap-1">
			<p-checkbox inputId="websiteSelect" formControlName="isWebsiteEnabled" [binary]="true" />
			<div class="flex flex-column">
				<label for="websiteSelect" class="ml-2">
					Enable website button
					<p class="text-xs text-color-secondary">Show the website button on your public profile</p>
				</label>
			</div>
		</div>

		<div class="flex gap-1">
			<p-checkbox inputId="whatsappSelect" formControlName="isWhatsappEnabled" [binary]="true" />
			<div class="flex flex-column">
				<label for="whatsappSelect" class="ml-2">
					Enable WhatsApp button
					<p class="text-xs text-color-secondary">Show the WhatsApp button on your public profile to send a message to the associated number</p>
				</label>
			</div>
		</div>

		<div class="flex gap-1">
			<p-checkbox inputId="vCardSelect" formControlName="isVcardEnabled" [binary]="true" />
			<div class="flex flex-column">
				<label for="vCardSelect" class="ml-2">
					Enable vCard button
					<p class="text-xs text-color-secondary">Show the vCard button on your public profile to save your contact details on mobile devices</p>
				</label>
			</div>
		</div>

		<div class="flex gap-2 flex-column mt-2">
			<p-button label="Update Profile" fluid="true" type="submit" [disabled]="!form.valid" />
			<div class="flex gap-2 w-full">
				<p-button icon="pi pi-user text-sm" label="Go to Profile" severity="secondary" outlined="true" [routerLink]="'/u/' + userData?.slug" fluid="true" class="w-full" [disabled]="!userData?.slug || !isProfileConfigured()"/>
				<p-button icon="pi pi-share-alt text-xs" severity="secondary" outlined="true"  [style]="{height: '100%'}" (click)="shareProfile()"/>
			</div>
			<p-button *ngIf="!isAdmin" label="Disconnect" icon="pi pi-sign-out text-xs" severity="danger" outlined="true" fluid="true" (click)="disconnect()" />
		</div>
	</form>
</main>